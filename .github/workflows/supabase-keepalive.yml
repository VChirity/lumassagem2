# Mantém os projetos Supabase ativos (evita pausa por inatividade no plano gratuito).
# Roda todo dia e faz uma requisição leve em cada projeto listado em supabase-keepalive-projects.json
name: Supabase keep-alive

on:
  schedule:
    # Todo dia às 12:00 UTC (09:00 BRT)
    - cron: "0 12 * * *"
  workflow_dispatch: # Rodar manualmente: Actions > Supabase keep-alive > Run workflow

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ping Supabase (todos os projetos)
        run: |
          CONFIG=".github/supabase-keepalive-projects.json"
          if [ ! -f "$CONFIG" ]; then
            echo "Arquivo $CONFIG não encontrado."
            exit 1
          fi
          COUNT=$(jq length "$CONFIG")
          echo "Encontrados $COUNT projeto(s) para pingar."
          FAILED=0
          for i in $(seq 0 $((COUNT - 1))); do
            NAME=$(jq -r ".[$i].name" "$CONFIG")
            URL=$(jq -r ".[$i].url" "$CONFIG")
            KEY=$(jq -r ".[$i].anonKey" "$CONFIG")
            if [ "$URL" = "null" ] || [ "$URL" == "" ] || [[ "$URL" == COLE_* ]]; then
              echo "[$NAME] Ignorado (URL não configurado)."
              continue
            fi
            OK=0
            if [ "$KEY" != "null" ] && [ "$KEY" != "" ] && [[ "$KEY" != COLE_* ]]; then
              CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                -H "apikey: $KEY" \
                -H "Authorization: Bearer $KEY" \
                -H "Accept: application/json" \
                "$URL/rest/v1/")
              if [ "$CODE" -lt 400 ]; then
                echo "[$NAME] HTTP $CODE (REST) - projeto ativo."
                OK=1
              fi
            fi
            if [ "$OK" -eq 0 ]; then
              CODE=$(curl -s -o /dev/null -w "%{http_code}" "$URL/auth/v1/health")
              if [ "$CODE" -lt 400 ]; then
                echo "[$NAME] HTTP $CODE (health) - projeto ativo."
                OK=1
              fi
            fi
            if [ "$OK" -eq 0 ]; then
              echo "[$NAME] FALHOU (REST e health). Verifique URL e chave."
              FAILED=1
            fi
          done
          if [ "$FAILED" -eq 1 ]; then
            echo "Um ou mais projetos falharam."
            exit 1
          fi
          echo "Todos os projetos respondendo."
