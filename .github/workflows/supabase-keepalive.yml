# Mantém os projetos Supabase ativos (evita pausa por inatividade no plano gratuito).
# Roda todo dia e faz uma requisição leve em cada projeto listado em supabase-keepalive-projects.json
name: Supabase keep-alive

on:
  schedule:
    # Todo dia às 12:00 UTC (09:00 BRT)
    - cron: "0 12 * * *"
  workflow_dispatch: # Rodar manualmente: Actions > Supabase keep-alive > Run workflow

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ping Supabase (todos os projetos)
        run: |
          CONFIG=".github/supabase-keepalive-projects.json"
          if [ ! -f "$CONFIG" ]; then
            echo "Arquivo $CONFIG não encontrado."
            exit 1
          fi
          COUNT=$(jq length "$CONFIG")
          echo "Encontrados $COUNT projeto(s) para pingar."
          FAILED=0
          for i in $(seq 0 $((COUNT - 1))); do
            NAME=$(jq -r ".[$i].name" "$CONFIG")
            URL=$(jq -r ".[$i].url" "$CONFIG")
            KEY=$(jq -r ".[$i].anonKey" "$CONFIG")
            if [ "$URL" = "null" ] || [ "$KEY" = "null" ] || [[ "$URL" == COLE_* ]] || [[ "$KEY" == COLE_* ]]; then
              echo "[$NAME] Ignorado (URL ou anonKey não configurado)."
              continue
            fi
            CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "apikey: $KEY" \
              -H "Authorization: Bearer $KEY" \
              -H "Accept: application/json" \
              "$URL/rest/v1/")
            if [ "$CODE" -ge 400 ]; then
              echo "[$NAME] HTTP $CODE - FALHOU (verifique URL e chave publishable)."
              FAILED=1
            else
              echo "[$NAME] HTTP $CODE - projeto ativo."
            fi
          done
          if [ "$FAILED" -eq 1 ]; then
            echo "Um ou mais projetos falharam. Confira a chave publishable (pode estar incompleta)."
            exit 1
          fi
          echo "Todos os projetos respondendo."
